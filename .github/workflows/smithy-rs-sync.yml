on:
  workflow_dispatch:
  pull_request:
  schedule:
    # Run at the top of the hour, every hour
    - cron:  '0 * * * *'

name: Sync with smithy-rs commits

env:
  rust_version: 1.54.0
  rust_toolchain_components: clippy,rustfmt
  java_version: 11

jobs:
  run-sync-tool:
    runs-on: ubuntu-latest
    steps:
    - name: checkout aws-sdk-rust
      uses: actions/checkout@v2
      with:
        ref: next
        path: aws-sdk-rust
        fetch-depth: 0
    - name: checkout smithy-rs
      uses: actions/checkout@v2
      with:
        repository: awslabs/smithy-rs
        ref: sync-script-iteration
        path: smithy-rs
        fetch-depth: 0
    # - name: checkout aws-sdk-rust
    #   run: git clone --branch next https://github.com/awslabs/aws-sdk-rust.git aws-sdk-rust
    # - name: checkout smithy-rs
    #   run: git clone --branch sync-script-iteration https://github.com/awslabs/smithy-rs.git smithy-rs
    - uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.rust_version }}
        components: ${{ env.rust_toolchain_components }}
        default: true
    - uses: actions/setup-java@v1
      with:
        java-version: ${{ env.java_version }}
    - name: fetch aws-sdk-rust
      working-directory: aws-sdk-rust
      run: git fetch --no-tags --progress --no-recurse-submodules --depth=1 origin next
    - name: fetch smithy-rs
      working-directory: smithy-rs
      run: git fetch --no-tags --progress --no-recurse-submodules --depth=1 origin sync-script-iteration
    - name: run sync tool
      working-directory: smithy-rs/tools/smithy-rs-sync
      run: |
        cargo run -- \
          --smithy-rs /home/runner/work/aws-sdk-rust/aws-sdk-rust/smithy-rs \
          --aws-sdk /home/runner/work/aws-sdk-rust/aws-sdk-rust/aws-sdk-rust
    - name: push commits
      run: git push
      working-directory: aws-sdk-rust
