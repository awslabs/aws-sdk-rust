on: [ pull_request ]

env:
  rust_version: 1.53.0

name: CI

jobs:
  test:
    runs-on: ubuntu-latest
    name: Compile & Test SDK
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ env.rust_version }}
          default: true
      # Pinned to the commit hash of v1.3.0
      - uses: Swatinem/rust-cache@842ef286fff290e445b90b4002cc9807c3669641
        with:
          sharedKey: test
          working-directory: sdk
      - name: Cargo Test
        run: cargo test
        env:
          CARGO_INCREMENTAL: 'false'
        working-directory: sdk

  # Check for CVE-2021-42574 using Rust 1.56.1 which added the lints.
  # Once our MSRV is >= 1.56.1, this job can be removed.
  cve-2021-42574:
    runs-on: ubuntu-latest
    name: Check for CVE-2021-42574
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.56.1
          default: true
      # Pinned to the commit hash of v1.3.0
      - uses: Swatinem/rust-cache@842ef286fff290e445b90b4002cc9807c3669641
        with:
          sharedKey: cve-2021-42574
          working-directory: sdk
      - name: Cargo Check
        run: cargo check
        env:
          CARGO_INCREMENTAL: 'false'
        working-directory: sdk
