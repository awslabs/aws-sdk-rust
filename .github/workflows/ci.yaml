on: [pull_request]

name: CI

jobs:
  generate-test-matrix:
    runs-on: ubuntu-latest
    name: Generate Test Matrix
    steps:
      - uses: actions/checkout@v2
      - name: Generate the matrix
        id: generate-matrix
        # Run the `get-ci-matrix.py` script to calculate a test matrix for the `test` job.
        # This script outputs JSON that GitHub Actions can consume as a matrix definition.
        # Rust versions to test against are arguments to this script.
        run: echo "::set-output name=matrix::$(./tools/ci/get-ci-matrix.py 1.54.0 1.56.1)"
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}

  test:
    needs: generate-test-matrix
    runs-on: ubuntu-latest
    name: Compile & Test SDK
    env:
      CARGO_INCREMENTAL: "0"
    strategy:
      # Use the matrix generated by the previous job
      matrix: ${{ fromJson(needs.generate-test-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ matrix.rust_version }}
          default: true
      # Pinned to the commit hash of v1.3.0
      - uses: Swatinem/rust-cache@842ef286fff290e445b90b4002cc9807c3669641
        with:
          sharedKey: test
      - name: Cargo Test
        run: |
          # HACK: The workspace smithy-rs generates is invalid.
          # This can be removed once https://github.com/awslabs/smithy-rs/pull/957
          # is merged into aws-sdk-rust.
          rm Cargo.toml

          ./tools/ci/run-cmd-on-crate-range.py ${{ matrix.crate_range }} cargo test

  # Psuedo-job that depends on the test job so that we don't have to enter
  # the myriad of test range combinations into GitHub's protected branch rules
  require-tests:
    needs: test
    runs-on: ubuntu-latest
    name: Test Matrix Success
    steps:
      - name: Run
        run: echo "We should only get this far if the test matrix succeeded."

  check-manifests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.56.1
          default: true
      # Pinned to the commit hash of v1.3.0
      - uses: Swatinem/rust-cache@842ef286fff290e445b90b4002cc9807c3669641
        with:
          sharedKey: check-manifests
      - name: check manifests
        working-directory: tools/publisher
        run: cargo run fix-manifests --check
